<h1><%= @contest.title %></h1>

<% if Time.now < @contest.start_time %>
時間の編集可能 <%= @contest.start_time %>
<% end %>
<div class="vote_title">あと</div><div class="vote_count"><%= @vote %></div><div class="vote_title">票投稿可能</div><br />
<div class="select">なし</div>
<div class="select">なし</div>
<div class="select">なし</div>

<% if @contest.end_time < Time.now or Time.now < @contest.start_time %>
<h2>投票不可能</h2>
<div class="row">
  <%= 20.times do %>
    <div class="col s4 m3">
      <div class="card">
        <div class="card-image">
          <%=image_tag asset_path('dog.jpg') %>
          <span class="card-title">タイトル</span>
        </div>
        <div class="card-content">
          <p>説明文</p>
        </div>
        <div class="card-action">
          <a href="#">リンク</a>
        </div>
      </div>
    </div>
  <% end %>
</div>
<% else %>
<h2>投票可能</h2>
<div class="row">
  <%= 20.times do %>
    <div class="col s4 m3">
      <div class="card">
        <div class="card-image">
          <%=image_tag asset_path('dog.jpg') %>
          <span class="card-title">タイトル</span>
        </div>
        <div class="card-content">
          <p>説明文</p>
        </div>
        <div class="card-action">
          <a href="#">リンク</a>
        </div>
      </div>
    </div>
  <% end %>
</div>
<% end %>

<script>

// 指定したindexの番号を消します
clean_select = function(index) {
  for(var i = 0 ; i < 3 ; i ++){
    if($('div.select')[i].textContent == index + 1){
      $('div.select')[i].textContent = 'なし'
    }
  }
}

// 
pack_select = function() {
  var now;
  for(var i = 0, now = 0 ; i < 3 ; i ++){
    if($('div.select')[i].textContent != 'なし'){
      $('div.select')[now].textContent = $('div.select')[i].textContent
      now ++
    }      
  }

  for( ; now < 3 ; now ++){
    $('div.select')[now].textContent = 'なし'
  }
}

$('div.card-image').on('click', function(){
  point = Number($('div.vote_count')[0].textContent)
  var index = $('div.card-image').index(this);
  if(!$(this).hasClass('active')){ // 選択する
    console.log([point, index])
    $('div.select')[3-point].textContent = index + 1
    if(point != 0){
      $(this).parent().css("border", "1px solid #ff0000")
      $(this).toggleClass('active')
      point --
    }
  } else { // 選択を外す
    clean_select(index)
    $(this).parent().css("border", "none")
    $(this).toggleClass('active')
    point ++
  }
  pack_select()
  console.log(index + 'th item clicked!');
  console.log(point)
  $('div.vote_count')[0].textContent = point
});
</script>

<style>
div.vote_count, .vote_title, .select{
  float:left;
}
</style>